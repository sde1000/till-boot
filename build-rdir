#!/bin/bash

set -e

arch=$1

if [ "x$arch" = "x" ]; then
  echo "Usage: build-rdir arch"
  exit 1
fi

if [ ${UID} != 0 ]; then
  echo "This script must be run as root."
  exit 1
fi

echo Building rdir for $arch

# Address of pub company's apt repository to be baked into the image
repoaddr=http://www.individualpubs.co.uk/software

distribution=bionic

# Don't install quicktill; we fetch that on each boot because it may
# be harmful to install an old version.  install=quicktill3 is needed
# as a kernel command line argument.

extrainstall_norecommends="postgresql-client openssh-client ntp acpid python3-psycopg2 python3-reportlab python3-httplib2 python3-qrcode python3-sqlalchemy python3-yaml quicktill-nfc-bridge oidentd usbutils pciutils python3-cups python3-odf telnet strace tcpdump python3-twython python3-oauthlib python3-requests python3-matplotlib wget man-db python3-dateutil dmidecode"

extrainstall_recommends="xinit python3-gi-cairo gir1.2-gtk-3.0 ttf-ubuntu-font-family xterm matchbox-window-manager x11-xserver-utils"

target=./rdir-${arch}
manifest=${target}-filesystem.manifest
diskdefines=${target}-README.diskdefines

export http_proxy=http://localhost:3142/
source=http://gb.archive.ubuntu.com/ubuntu/

rm -rf $target $manifest $diskdefines
mkdir $target

echo Running debootstrap
debootstrap --arch=${arch} $distribution $target $source 2>&1

# Seed the target with some useful files
cat >$target/etc/default/locale <<EOF
LANG="en_GB.UTF-8"
EOF

cat >$target/etc/apt/apt.conf.d/40proxy <<EOF
Acquire::http::Proxy "$http_proxy";
EOF
cat >$target/etc/apt/sources.list <<EOF
deb http://gb.archive.ubuntu.com/ubuntu $distribution main restricted universe multiverse
deb http://gb.archive.ubuntu.com/ubuntu $distribution-updates main restricted universe multiverse
deb http://security.ubuntu.com/ubuntu $distribution-security main restricted universe multiverse
deb $repoaddr $distribution-tills main
EOF

cp repo-signing-key.gpg $target/etc/apt/trusted.gpg.d/ipltd-repo-signing-key.asc

# Copy the setup script into the target
cp -r scripts $target/root/
echo $extrainstall_norecommends >$target/root/extrainstall_norecommends
echo $extrainstall_recommends >$target/root/extrainstall_recommends

# Invoke the setup script in the target
systemd-nspawn -D $target/ -a /root/scripts/chroot-setup

# Clean up
rm $target/root/extrainstall_norecommends
rm $target/root/extrainstall_recommends
rm -r $target/root/scripts

# Leave only our private repository in the apt sources list
cat >$target/etc/apt/sources.list <<EOF
deb $repoaddr $distribution-tills main
deb-src $repoaddr $distribution-tills main
EOF
# Don't use our local proxy to fetch packages any more
rm $target/etc/apt/apt.conf.d/40proxy

# Zap /etc/resolv.conf - a new one will be generated on boot by casper
rm -f $target/etc/resolv.conf

# The diskless terminal thinks it is called "till".  The real till is
# probably also called "till".  Look at the DNS first to get the right answer!
sed "s/^hosts:.*$/hosts: mdns4_minimal \\[NOTFOUND=return] dns files/" <$target/etc/nsswitch.conf >$target/etc/nsswitch.conf.new
mv $target/etc/nsswitch.conf.new $target/etc/nsswitch.conf

# For some reason the "lp" module is not loaded automatically, so
# we have to add it to /etc/modules here
echo lp >>$target/etc/modules

# Zap the machine ID so it's regenerated on each reboot
rm $target/var/lib/dbus/machine-id

# Build the manifest file
chroot $target dpkg-query -W --showformat='${Package} ${Version}\n' >${manifest}

# Diskdefines
cat >${diskdefines} <<EOF
#define DISKNAME  quicktill netboot Ubuntu Bionic
#define TYPE  binary
#define TYPEbinary  1
#define ARCH  ${arch}
#define ARCH${arch}  1
#define DISKNUM  1
#define DISKNUM1  1
#define TOTALNUM  0
#define TOTALNUM0  1
EOF
